<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Validacion de usuarios</title>

<link rel="stylesheet" type="text/css" href="css/idioma.css">
<link rel="stylesheet" type="text/css" href="css/tema.css">
<link rel="stylesheet" type="text/css" href="css/style.css">


<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
  <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
  <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
<script type="text/javascript" src="js/offline.js"></script>
</head>
 
<body>

	<div data-role="page" id="inicio">
	    <canvas id="canvas"></canvas>
		<div data-role="header" class="none">

		<img id="logo" src="img/logo.svg">


		</div>


	
		<div data-role="content">	
		<canvas id="canvas"></canvas>
		
		<form id="formulario" >
		<!--
		<label> Usuario </label>-->
		<input type="text" id="nombredeusuario" name="nombredeusuario">
		<!--<label> Password </label>-->
		<input type="password" id="clave" name="clave" >
		 
		<input type="submit" value="Login">
		</form>	
		</div>
	</div>

	<div data-role="page" id="home" class="page">
	
		<div data-role="header" class="none">
		<h1 id="titulo"></h1>
		</div>
		 
		<div data-role="main">	
		
		<h3> Proyectos en desarrollo:</h3>
		<div id="proyectos">
			

		</div>
		</div>
 
	</div>


	<div data-role="page" id="projects" class="page">
	
		<div data-role="header"  class="none header">
		<h1 id="tituloProyectos"></h1>
		</div>
		 
		 <div id="entregas">
		

		</div>
		</div>
 
	</div>



	<div data-role="page" id="tarea" class="page">
	
		<div data-role="header"  class="none header">
		<h1 id="tituloTarea"></h1>
		</div>
		 
		 <div id="coments">
		

		</div>

		<div class="agregarComent">
			
			<form id="agregarCom">
				
				<textarea  id="coment" value="Agregar comentario"></textarea>
				<input type="submit" id="submitCom" value="comentar">

			</form>

		</div>
		</div>
 
	</div>


<script>
	
	var visitedProj = false;
	var visitedTareas = false;
	var visitedComents = false;
	var actualizedComents = true;


	init();

	function init() { document.addEventListener("deviceready", onDeviceReady(), false); }

	function onDeviceReady() {  checkConexion();}
	
	function checkConexion() {

		// Pregunto por conexión.

		if (navigator.onLine) {
			
			console.log('online');
			var datosGuardados;

			if(localStorage==undefined){
				console.log("Vaceeoo");

				needLogin();
			} 

			else{

				//needLogin();
		 		var datosGuardados = localStorage.getItem("datos");
			  	var datosObjeto = JSON.parse(datosGuardados); 
				var usuario = datosObjeto.usuario;
				console.log(localStorage);

		    	userLogged();
			}
		}	

		else {  console.log('offline');	}

	} 


////////////////////////////////////////////////////////////////////////////////////////////////////////


function userLogged(){

	var datosGuardados = localStorage.getItem("datos");
	var datosObjeto = JSON.parse(datosGuardados); 
	var usuario = datosObjeto.usuario;

	console.log(datosObjeto);
						

	$("#inicio").on("pagebeforeshow", function() { 

		$.mobile.pageContainer.pagecontainer({ defaults: true });
		var home = $("#home" );
		$( ":mobile-pagecontainer" ).pagecontainer( "change", home, {  'reload': true,  'allowSamePageTransition': true  });
					
	});


	$("#home").on("pageshow", function(){


		if(!visitedProj){

			$("#titulo").append("Bienvenido, "+ usuario);
							
			var elementos = (Object.keys(datosObjeto).length)-3;
			
			for(var i=0; i<elementos; i++){

				$("#proyectos").append('<div class="proyWp"><a class="proToggle" data-idProy="'+i+'" href="#">' + datosObjeto[i][0].nombre + '</a></div>');
							
			}

			visitedProj = true;

		};


		$(".proToggle").click(function(){

			var idPro =  $(this).attr("data-idProy");
			var titul =  $(this).text();
						
			loadTareas(datosObjeto, idPro , titul);

		});
						
	});
				
}; 



// Funciones generales: (atemporales a la conexion);

function loadTareas(objetoJson, idPro, tit){

	console.log("ojeto" + objetoJson );
	var idProyecto =  idPro;
	var tituloPro = tit;

	console.log(idProyecto);
	console.log(tituloPro);

	$.mobile.changePage("#projects");

	if(!visitedTareas){

		visitedTareas = true;


		$("#tituloProyectos").append(tituloPro);

		var entregas =  (Object.keys(objetoJson[idProyecto].entregas).length);
		console.log("entregaaaaaaaas" + entregas );
								
		for(var j=0; j<entregas; j++){

			$("#entregas").append('<a class="entregaToggle" data-numEntrega="'+j+'" href="#">' + objetoJson[idProyecto].entregas[j][0].titulo + '</a>');
			var tareas =  (Object.keys(objetoJson[idProyecto].entregas[j].tareas).length);

			if(tareas>0){

				for(var k=0; k<tareas; k++){

					$("#entregas").append('<div class="tareasWp"><div class="hiden"><input class="check" type="checkbox" name="'+objetoJson[idProyecto].entregas[j].tareas[k][0].titulo+'" value=""><p class="tarea">'+objetoJson[idProyecto].entregas[j].tareas[k][0].titulo +'</p></div ><div class="tagsWp"><span class="fecha">'+objetoJson[idProyecto].entregas[j].tareas[k][0].entrega+'</span></div><div class="comentsWp"><span class="coments"><a class="com" href="#">'+objetoJson[idProyecto].entregas[j].tareas[k][0].numComentarios+' comentarios</a></span></div></div>');
											

					$("#entregas").append('');

				}


				$(".com").click(function(){

					titulo = $(this).text();

						getComents(titulo);
					
				});


			}
		
		}

		



	}


$(".com").click(function(){

	titulo = $(this).text();

		getComents(titulo);
	
});


};



// OBTENER LS SI NO ESTOY LOGUEADO.

function needLogin(){
				
			console.log("necesitamos log");			
	


$('#formulario').submit(function() {

	alert("h");


		var datosUsuario = $("#nombredeusuario").val();
		var datosPassword = $("#clave").val();
		archivoValidacion = "validacionReal2.php?jsoncallback=?";
						 
		$.getJSON( archivoValidacion, { usuario:datosUsuario ,password:datosPassword}) 
		
		.done(function(respuestaServer) {

			if(respuestaServer.validacion == "ok"){ 

				datosLocales = JSON.stringify(respuestaServer);
			
				localStorage.setItem("datos", datosLocales);
				datosGuardados = localStorage.getItem("datos");
				datosObjeto = JSON.parse(datosGuardados); 
				usuario = datosObjeto.usuario;


				$.mobile.changePage("#home");
				
				alert("h");


				$("#home").on("pageshow", function(){
					alert("j");
					console.log("bienvenido");
			
				   $("#titulo").append("Bienvenido, "+ datosObjeto.usuario);
								
					var elementos = (Object.keys(datosObjeto).length)-3;

				
					for(var i=0; i<elementos; i++){
				
						$("#proyectos").append('<div class="proyWp"><a class="proToggle" data-idProy="'+i+'" href="#">' + datosObjeto[i][0].nombre + '</a></div>');
								
					};



					$(".proToggle").click(function(){

						var idProyecto =  $(this).attr("data-idProy");
						var tituloPro =  $(this).text();

						$.mobile.changePage("#projects");
						$("#tituloProyectos").append(tituloPro);


						var entregas =  (Object.keys(datosObjeto[idProyecto].entregas).length);
						console.log("entregaaaaaaaas" + entregas );
												
						for(var j=0; j<entregas; j++){

							$("#entregas").append('<a class="entregaToggle" data-numEntrega="'+j+'" href="#">' + datosObjeto[idProyecto].entregas[j][0].titulo + '</a>');
							var tareas =  (Object.keys(datosObjeto[idProyecto].entregas[j].tareas).length);

							if(tareas>0){

								for(var k=0; k<tareas; k++){

									$("#entregas").append('<div class="tareasWp"><div class="hiden"><input class="check" type="checkbox" name="'+datosObjeto[idProyecto].entregas[j].tareas[k][0].titulo+'" value=""><p class="tarea">'+datosObjeto[idProyecto].entregas[j].tareas[k][0].titulo +'</p></div ><div class="tagsWp"><span class="fecha">'+datosObjeto[idProyecto].entregas[j].tareas[k][0].entrega+'</span></div><div class="comentsWp"><span class="coments"><a class="com" href="#">'+datosObjeto[idProyecto].entregas[j].tareas[k][0].numComentarios+' comentarios</a></span></div></div>');
															

									$("#entregas").append('');

								}


								$(".com").click(function(){

									titulo = $(this).text();

										getComents(titulo);
									
								});


							};
						};
					});
					
				});

			} else{

			 	console.log("lo sentimos ha habido un problema");
				
			} 

		
							
		});

	});


			
};

// ACTUALIZAR LISTA DE COMENTS

function getComents(titulo){

	$.mobile.changePage("#tarea");

	console.log("hola!");

	$("#tarea").on("pageshow", function(){


		if(!visitedComents){
			visitedComents = true;
	
								
				$("#tituloTarea").text(titulo);

				archivoComentarios = "getComentarios.php?jsoncallback=?"
				$.getJSON( archivoComentarios, { idTarea:2}) 
				.done(function(comentarios) {

				if(comentarios.validacion == "ok"){ 

				    	console.log(comentarios);
						var comentariosCant = (Object.keys(comentarios).length)
			
						for(i=0;i<comentariosCant;i++){

							$("#coments").append('<p>'+comentarios[i][0].comentario+'</p>');
							$("#coments").append('<p>'+comentarios[i][0].usuario+'</p>');


						}
											
					}
				});

		};


	});
	
};








function actualizarComents(){

	$.mobile.changePage("#tarea");

	actualizedComents=true;

	$("#tarea").on("pageshow", function(){

						
		$("#tituloTarea").text("Comantarios");

		$("#coment").val("");

			archivoComentarios = "getComentarios.php?jsoncallback=?"
			$.getJSON( archivoComentarios, { idTarea:2}) 
			.done(function(comentarios) {
		
			if(comentarios.validacion == "ok"){ 
				    	console.log("entramos");
						var comentariosCant = (Object.keys(comentarios).length)
			
						lastComent = comentariosCant-2;
						console.log(comentarios);

						$("#coments").append('<p>'+comentarios[lastComent][0].comentario+'</p>');
						$("#coments").append('<p>'+comentarios[lastComent][0].usuario+'</p>');

						
											
					}
			});
		

	});

	actualizarTareas();

	console.log("lo mande a actualizar");

}



function actualizarTareas(){

	var datosUsuario = "mr";
	var datosPassword ="123"
	archivoValidacion = "validacionReal2.php?jsoncallback=?"
					 
	$.getJSON( archivoValidacion, { usuario:datosUsuario ,password:datosPassword}) 
					
	.done(function(respuestaServer) {

		if(respuestaServer.validacion == "ok"){ 

			console.log("bienvenido");
			var datosLocales = JSON.stringify(respuestaServer);
			//alert(datosLocales);
			localStorage.setItem("datos", datosLocales);
			var datosGuardados = localStorage.getItem("datos");
			var datosObjeto = JSON.parse(datosGuardados); 
			var usuario = datosObjeto.usuario;
			
			
		 } else{
	
		 	console.log("lo sentimos ha habido un problema");
		 } 

	});


		var entregas =  (Object.keys(datosObjeto[idProyecto].entregas).length);
		console.log("entregaaaaaaaas" + entregas );
								
		for(var j=0; j<entregas; j++){

			$("#entregas").append('<a class="entregaToggle" data-numEntrega="'+j+'" href="#">' + datosObjeto[idProyecto].entregas[j][0].titulo + '</a>');
			var tareas =  (Object.keys(datosObjeto[idProyecto].entregas[j].tareas).length);

			if(tareas>0){

				for(var k=0; k<tareas; k++){

					$("#entregas").append('<div class="tareasWp"><div class="hiden"><input class="check" type="checkbox" name="'+datosObjeto[idProyecto].entregas[j].tareas[k][0].titulo+'" value=""><p class="tarea">'+datosObjeto[idProyecto].entregas[j].tareas[k][0].titulo +'</p></div ><div class="tagsWp"><span class="fecha">'+datosObjeto[idProyecto].entregas[j].tareas[k][0].entrega+'</span></div><div class="comentsWp"><span class="coments"><a class="com" href="#">'+datosObjeto[idProyecto].entregas[j].tareas[k][0].numComentarios+' comentarios</a></span></div></div>');
											

					$("#entregas").append('');

				}


				$(".com").click(function(){

					titulo = $(this).text();

						getComents(titulo);
					
				});


			};
		
		};


	alert("se termino de actualizar todo");


}


function refreshPage() {

	console.log("h")
  $.mobile.changePage(
    window.location.href,
    {
      allowSamePageTransition : true,
      transition              : 'none',
      showLoadMsg             : false,
      reloadPage              : true
    }
  );
};


// AGREGAR COMENTARIO.


$('#agregarCom').submit(function() {

	var coment = $("#coment").val();

	actualizedComents = false;

	archivoComentarios = "addComentario.php?jsoncallback=?"
		$.getJSON( archivoComentarios, { idTarea:2, idUsuario:2, comentario: coment}) 
		.done(function(nuevoComentario) {

		
		if(nuevoComentario.validacion == "ok"){ 
			actualizarComents();
		 
		  }

		});
	});




</script>



<script type="text/javascript" src="function/bg.js"></script>
<script type="text/javascript" src="cordova.js"></script> 

</body>
</html>